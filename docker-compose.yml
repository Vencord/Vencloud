version: "3.1"

services:
    redis:
        image: redis:alpine
        restart: always
        volumes:
            - ./redis-data:/data
        environment:
            REDIS_ARGS: --save 300 1 60 10
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5

    backend:
        image: vencord/backend
        build: .
        restart: always
        depends_on:
            redis:
                condition: service_healthy
        environment:
            PORT: ${PORT}
            HOST: ${HOST}
            ROOT_REDIRECT: ${ROOT_REDIRECT}
            DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
            DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}
            DISCORD_REDIRECT_URI: ${DISCORD_REDIRECT_URI}
            PEPPER_SECRETS: ${PEPPER_SECRETS}
            PEPPER_SETTINGS: ${PEPPER_SETTINGS}
            SIZE_LIMIT: ${SIZE_LIMIT}
            ALLOWED_USERS: ${ALLOWED_USERS}
            PROMETHEUS: ${PROMETHEUS}
        ports:
            - ${PORT}:${PORT}/tcp